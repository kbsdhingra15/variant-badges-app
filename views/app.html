<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variant Badges App</title>
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f4f6f8;
        color: #202223;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
      }

      .status-badge.connected {
        background: #d1f0e5;
        color: #008060;
      }

      .status-badge.loading {
        background: #fff4cc;
        color: #916a00;
      }

      .status-badge.error {
        background: #ffc2c2;
        color: #bf0711;
      }

      .products-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .product-card {
        border: 1px solid #e1e3e5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .product-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #202223;
      }

      .variant-row {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 1px solid #e1e3e5;
        border-radius: 4px;
        margin-bottom: 10px;
        background: #fafbfb;
      }

      .variant-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
        background: #e1e3e5;
      }

      .variant-info {
        flex: 1;
      }

      .variant-info strong {
        display: block;
        margin-bottom: 4px;
        font-size: 15px;
      }

      .variant-option {
        font-size: 13px;
        color: #6d7175;
        margin-top: 2px;
      }

      .success {
        background: #d1f0e5;
        color: #008060;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #008060;
      }

      .error {
        background: #ffc2c2;
        color: #bf0711;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #bf0711;
      }

      .warning {
        background: #fff4cc;
        color: #916a00;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #916a00;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6d7175;
      }

      .empty-state h2 {
        font-size: 20px;
        margin-bottom: 10px;
        color: #202223;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üé® Variant Badges</h1>
      <span class="status-badge loading" id="status">Loading...</span>
    </div>

    <div class="products-container">
      <div id="products">
        <div class="empty-state">
          <h2>Loading your products...</h2>
          <p>Please wait while we connect to your store</p>
        </div>
      </div>
    </div>

    <script>
      // Get shop domain from URL
      const urlParams = new URLSearchParams(window.location.search);
      const shop = urlParams.get("shop");
      const host = urlParams.get("host");
      const appHost = "{{APP_HOST}}"; // Will be replaced by server

      let app = null;

      console.log("üé® Variant Badges App Loading...");
      console.log("   Shop:", shop);
      console.log("   Host:", host);
      console.log("   App Host:", appHost);

      // Get session token from URL fragment (App Bridge provides this)
      function getSessionTokenFromURL() {
        const hash = window.location.hash;
        if (hash && hash.includes("id_token=")) {
          const token = hash.split("id_token=")[1].split("&")[0];
          console.log("‚úÖ Found session token in URL fragment");
          return token;
        }
        console.log("‚ö†Ô∏è  No session token in URL fragment");
        return null;
      }

      // Initialize App Bridge
      function initAppBridge() {
        try {
          if (typeof createApp === "undefined") {
            console.log("‚ö†Ô∏è  App Bridge not loaded yet, waiting...");
            return false;
          }

          app = createApp({
            apiKey: "{{SHOPIFY_API_KEY}}", // Will be replaced by server
            host: host,
          });

          console.log("‚úÖ App Bridge initialized");
          return true;
        } catch (error) {
          console.error("‚ùå App Bridge initialization failed:", error);
          return false;
        }
      }

      // Get session token from App Bridge
      async function getSessionToken() {
        if (!app) {
          throw new Error("App Bridge not initialized");
        }

        try {
          const token = await app.idToken();
          console.log("‚úÖ Got session token from App Bridge");
          return token;
        } catch (error) {
          console.error("‚ùå Failed to get session token:", error);
          throw error;
        }
      }

      // Auto-refresh tokens
      function startTokenRefresh() {
        setInterval(async () => {
          try {
            await getSessionToken();
            console.log("üîÑ Token auto-refreshed");
          } catch (error) {
            console.log("‚ö†Ô∏è  Auto-refresh failed:", error.message);
          }
        }, 50000); // 50 seconds
      }

      // Initialize App Bridge immediately
      initAppBridge();

      // Load products
      async function loadProducts() {
        try {
          document.getElementById("status").textContent =
            "Getting Auth Token...";

          // Wait for App Bridge to be ready
          let attempts = 0;
          while (!app && attempts < 30) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }

          if (!app) {
            throw new Error("App Bridge failed to initialize");
          }

          // Get session token from App Bridge
          console.log("üîê Getting session token from App Bridge...");
          const sessionToken = await getSessionToken();

          if (!sessionToken) {
            throw new Error(
              "No session token found. Try reinstalling the app."
            );
          }

          console.log("‚úÖ Got session token, length:", sessionToken.length);

          document.getElementById("status").textContent = "Loading Products...";
          console.log("üì¶ Fetching products via GraphQL API...");

          const url = appHost + "/api/products";
          console.log("   URL:", url);

          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: "Bearer " + sessionToken,
              "Content-Type": "application/json",
            },
          });

          console.log("   Response status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();

            if (
              errorData.needsAuth ||
              errorData.error === "Shop not authenticated"
            ) {
              console.log("üîÑ Shop not authenticated - need OAuth");
              document.getElementById("status").textContent = "Installing...";

              const oauthUrl =
                appHost + "/auth?shop=" + encodeURIComponent(shop);

              // Show install button
              document.getElementById("products").innerHTML =
                '<div class="product-card" style="text-align: center; padding: 60px 20px;">' +
                '<h2 style="margin-bottom: 20px;">üì¶ App Installation Required</h2>' +
                '<p style="color: #6d7175; margin-bottom: 30px;">Click the button below to complete installation:</p>' +
                '<a href="' +
                escapeHtml(oauthUrl) +
                '" target="_top" style="' +
                "display: inline-block; padding: 16px 40px; background: #008060; color: white; " +
                'text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 16px;">' +
                "Complete Installation</a>" +
                "</div>";
              document.getElementById("status").textContent = "Action Required";
              return;
            }

            throw new Error(errorData.error || "HTTP " + response.status);
          }

          const data = await response.json();
          console.log(
            "‚úÖ Products received via GraphQL:",
            data.products.length
          );

          document.getElementById("status").textContent = "‚úÖ Connected";
          document.getElementById("status").className =
            "status-badge connected";
          displayProducts(data.products);
        } catch (error) {
          console.error("‚ùå Error loading products:", error);
          document.getElementById("status").textContent = "‚ùå Error";
          document.getElementById("status").className = "status-badge error";
          showError("Failed to load products: " + error.message);
        }
      }

      // Display products
      function displayProducts(products) {
        const container = document.getElementById("products");

        if (!products || products.length === 0) {
          container.innerHTML =
            '<div class="empty-state">' +
            "<h2>No Products Found</h2>" +
            "<p>Add some products with variants to your store to get started!</p>" +
            "</div>";
          return;
        }

        let html =
          '<div class="success"><strong>üéâ Success!</strong> Connected to your store and loaded products using GraphQL API.</div>';

        products.forEach((product) => {
          html += '<div class="product-card">';
          html +=
            '<div class="product-title">' +
            escapeHtml(product.title) +
            "</div>";

          if (product.variants && product.variants.length > 0) {
            product.variants.forEach((variant) => {
              html += '<div class="variant-row">';

              const image = variant.image_id
                ? product.images &&
                  product.images.find((img) => img.id === variant.image_id)
                : product.images && product.images[0];

              if (image && image.src) {
                html +=
                  '<img class="variant-image" src="' +
                  escapeHtml(image.src) +
                  '" />';
              } else {
                html +=
                  '<div class="variant-image" style="background:#e1e3e5"></div>';
              }

              html += '<div class="variant-info">';
              html += "<strong>" + escapeHtml(variant.title) + "</strong>";
              html +=
                '<div class="variant-option">Price: $' +
                escapeHtml(variant.price) +
                "</div>";

              if (variant.option1)
                html +=
                  '<div class="variant-option">Option 1: ' +
                  escapeHtml(variant.option1) +
                  "</div>";
              if (variant.option2)
                html +=
                  '<div class="variant-option">Option 2: ' +
                  escapeHtml(variant.option2) +
                  "</div>";
              if (variant.option3)
                html +=
                  '<div class="variant-option">Option 3: ' +
                  escapeHtml(variant.option3) +
                  "</div>";

              html += "</div>";
              html += "</div>";
            });
          }

          html += "</div>";
        });

        container.innerHTML = html;
      }

      // Show error
      function showError(message) {
        document.getElementById("products").innerHTML =
          '<div class="error"><strong>‚ùå Error:</strong><br>' +
          escapeHtml(message) +
          "</div>";
      }

      // Escape HTML
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text.toString();
        return div.innerHTML;
      }

      // Start loading
      loadProducts();
    </script>
  </body>
</html>
