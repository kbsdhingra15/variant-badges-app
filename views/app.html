<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variant Badges</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f6f6f7;
        color: #202223;
        line-height: 1.5;
      }

      /* Header */
      .app-header {
        background: white;
        border-bottom: 1px solid #e1e3e5;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .app-header h1 {
        font-size: 20px;
        font-weight: 600;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 4px;
        background: white;
        border-bottom: 1px solid #e1e3e5;
        padding: 0 24px;
      }
      .tab {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: #6d7175;
        font-weight: 500;
        transition: all 0.2s;
      }
      .tab:hover {
        color: #202223;
        background: #f6f6f7;
      }
      .tab.active {
        color: #008060;
        border-bottom-color: #008060;
      }

      /* Main Container */
      .app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      /* View Sections */
      .view-section {
        display: none;
      }
      .view-section.active {
        display: block;
      }

      /* Page Headers */
      .page-header {
        margin-bottom: 24px;
      }
      .page-header h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .page-header p {
        color: #6d7175;
        font-size: 14px;
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }
      .card h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      /* Banner */
      .banner {
        background: #fff9c4;
        border: 1px solid #f9a825;
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      .banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .banner-content {
        flex: 1;
      }
      .banner-content h4 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .banner-content p {
        font-size: 14px;
        color: #5c5c5c;
        margin-bottom: 12px;
      }
      .banner-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Buttons */
      .btn {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        text-decoration: none;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #008060;
        color: white;
      }
      .btn-primary:hover {
        background: #006e52;
      }
      .btn-secondary {
        background: white;
        color: #202223;
        border: 1px solid #c9cccf;
      }
      .btn-secondary:hover {
        background: #f6f6f7;
      }
      .btn-outline {
        background: transparent;
        color: #008060;
        border: 1px solid #008060;
      }
      .btn-outline:hover {
        background: #f0fdf9;
      }

      /* Form Elements */
      select,
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #c9cccf;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      /* Toggle */
      .toggle {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #c9cccf;
        transition: 0.3s;
        border-radius: 24px;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      .toggle input:checked + .toggle-slider {
        background-color: #008060;
      }
      .toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }

      /* Settings Row */
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid #e1e3e5;
      }
      .setting-row:last-child {
        border-bottom: none;
      }
      .setting-info h4 {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .setting-info p {
        font-size: 13px;
        color: #6d7175;
      }

      /* Badge List */
      .badge-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .badge-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f6f6f7;
        border-radius: 6px;
      }
      .badge-item-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .badge-preview {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-preview.hot {
        background: #ff4444;
        color: white;
      }
      .badge-preview.new {
        background: #4caf50;
        color: white;
      }
      .badge-preview.sale {
        background: #ff9800;
        color: white;
      }

      /* Banner */
      .banner {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        background: #fff9c4;
        border: 1px solid #f9a825;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .banner-content {
        flex: 1;
      }
      .banner-content h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
      }
      .banner-content p {
        margin: 0 0 16px 0;
        color: #5c5c5c;
        line-height: 1.5;
      }
      .banner-actions {
        display: flex;
        gap: 12px;
      }

      /* Pricing Grid */
      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }
      .pricing-card {
        background: white;
        border: 2px solid #e1e3e5;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s;
      }
      .pricing-card:hover {
        border-color: #008060;
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .pricing-card.featured {
        border-color: #008060;
        position: relative;
      }
      .pricing-badge {
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: #008060;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }
      .pricing-card h4 {
        font-size: 24px;
        margin-bottom: 8px;
      }
      .pricing-price {
        font-size: 48px;
        font-weight: 700;
        color: #008060;
        margin: 16px 0;
      }
      .pricing-price span {
        font-size: 24px;
        color: #6d7175;
      }
      .pricing-features {
        list-style: none;
        margin: 24px 0;
        text-align: left;
      }
      .pricing-features li {
        padding: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pricing-features li:before {
        content: "‚úì";
        color: #008060;
        font-weight: bold;
      }

      /* FAQ */
      .faq-item {
        border-bottom: 1px solid #e1e3e5;
        padding: 16px 0;
      }
      .faq-item:last-child {
        border-bottom: none;
      }
      .faq-question {
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
      }
      .faq-question:hover {
        color: #008060;
      }
      .faq-icon {
        transition: transform 0.3s;
      }
      .faq-icon.open {
        transform: rotate(180deg);
      }
      .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s;
        padding: 0;
        color: #6d7175;
        font-size: 14px;
        line-height: 1.6;
      }
      .faq-answer.open {
        max-height: 500px;
        padding: 12px 0;
      }

      /* Contact Grid */
      .contact-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }
      .contact-card {
        background: #f6f6f7;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .contact-icon {
        font-size: 32px;
        margin-bottom: 12px;
      }
      .contact-card h4 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      .contact-card p {
        font-size: 14px;
        color: #6d7175;
        margin-bottom: 12px;
      }

      /* Loading & Messages */
      .loading {
        text-align: center;
        padding: 40px;
        color: #6d7175;
      }
      .error {
        background: #ffebee;
        border: 1px solid #ef5350;
        color: #c62828;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
      }
      .success {
        background: #e8f5e9;
        border: 1px solid #66bb6a;
        color: #2e7d32;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
      }
      /* Mobile responsiveness - force override inline styles */
      @media (max-width: 430px) {
        /* Container */
        #products-list {
          padding: 8px !important;
        }

        /* Each product card */
        .badge-item {
          padding: 12px !important;
          margin-bottom: 12px !important;
        }

        /* Main flex container - FORCE vertical stack */
        .badge-item > div:first-child {
          display: flex !important;
          flex-direction: column !important;
          gap: 12px !important;
          align-items: flex-start !important;
        }

        /* Image + Info container */
        .badge-item > div:first-child > div:first-child {
          display: flex !important;
          flex-direction: row !important;
          width: 100% !important;
          gap: 12px !important;
        }

        /* Product info section */
        .badge-item > div:first-child > div:nth-child(2) {
          flex: 1 !important;
          min-width: 0 !important;
        }

        /* Dropdown & Preview container - FORCE vertical stack */
        .badge-item > div:last-child {
          display: flex !important;
          flex-direction: column !important;
          width: 100% !important;
          gap: 10px !important;
          margin-top: 12px !important;
        }

        /* Dropdown select - full width */
        .badge-item select {
          width: 100% !important;
          padding: 10px !important;
          font-size: 15px !important;
        }

        /* Preview button - full width */
        .badge-item button {
          width: 100% !important;
          padding: 10px 16px !important;
          font-size: 15px !important;
        }

        /* Product title */
        .badge-item > div > div > div:first-child {
          font-size: 15px !important;
          white-space: normal !important;
          overflow: visible !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- App Header -->
    <div class="app-header">
      <span style="font-size: 24px">üìõ</span>
      <h1>Variant Badges</h1>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('manage')">Manage Badges</div>
      <div class="tab" onclick="switchTab('settings')">Settings</div>
      <div class="tab" onclick="switchTab('plans')">Plans</div>
      <div class="tab" onclick="switchTab('help')">Help</div>
    </div>

    <div class="app-container">
  <!-- Onboarding Banner -->
  <div id="setup-banner" style="display: none">
    <div class="banner">
      <div class="banner-icon">‚ö†Ô∏è</div>
      <div class="banner-content">
        <h4>Complete Setup (30 seconds)</h4>
        <p>
          Badges are ready! Add them to your theme to make them visible to
          customers:
        </p>
        
        <!-- ADD THIS ORDERED LIST -->
        <ol style="margin: 12px 0 20px 20px; padding: 0; line-height: 1.8; color: #333; text-align: left;">
          <li>Click <strong>"Open Theme Editor"</strong> below</li>
          <li>Click <strong>"Add section"</strong> under Template</li>
          <li>Find and click <strong>"Variant Badges"</strong> under Apps</li>
          <li>This will create a new section as "Apps" and add "Variant Badges" block under it</li>
          <li>Click <strong>"Save"</strong> - Done! ‚úÖ</li>
        </ol>
        
        <div class="banner-actions">
          <button class="btn btn-primary" onclick="openThemeEditor()">
            üé® Open Theme Editor
          </button>
          <button class="btn btn-outline" onclick="dismissBanner()">
            Dismiss
          </button>
        </div>
      </div>
    </div>
  </div>

      <!-- MANAGE BADGES VIEW -->
      <div id="manage-view" class="view-section active">
        <div class="page-header">
          <h2>Manage Badges</h2>
          <p>Assign HOT, NEW, and SALE badges to product variants</p>
        </div>

        <!-- No option selected warning -->
        <div id="no-option-warning" style="display: none">
          <div class="banner">
            <div class="banner-icon">‚ö†Ô∏è</div>
            <div class="banner-content">
              <h4>Select Option Type First</h4>
              <p>
                Please go to Settings and select which product option (Color,
                Size, etc.) you want to assign badges to.
              </p>
              <div class="banner-actions">
                <button class="btn btn-primary" onclick="switchTab('settings')">
                  ‚öôÔ∏è Go to Settings
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Products list -->
        <div id="products-list-container" style="display: none">
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
              "
            >
              <h3 id="badge-assignments-title">Badge Assignments</h3>
              <div
                style="color: #6d7175; font-size: 14px"
                id="option-type-label"
              ></div>
            </div>
            <div id="products-list" class="badge-list"></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS VIEW -->
      <div id="settings-view" class="view-section">
        <div class="page-header">
          <h2>Settings</h2>
          <p>Configure your badge display preferences</p>
        </div>

        <div class="card">
          <h3>Badge Display</h3>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Enable Badge Display</h4>
              <p>Badges appear on variant swatches when enabled</p>
            </div>
            <label class="toggle">
              <input type="checkbox" id="enable-display" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Select variant type you want to apply badges to:</h4>
              <p>
                Choose which product option (Color, Size, etc.) will display
                badges
              </p>
            </div>
            <select id="option-type" style="width: 200px">
              <option value="">Select an option type...</option>
              <option value="Color">Color</option>
              <option value="Size">Size</option>
              <option value="Style">Style</option>
              <option value="Material">Material</option>
            </select>
          </div>

          <button class="btn btn-primary" onclick="saveSettings()">
            Save Settings
          </button>
        </div>
      </div>

      <!-- PLANS VIEW -->
      <div id="plans-view" class="view-section">
        <div class="page-header">
          <h2>Plans & Pricing</h2>
          <p>Choose the plan that fits your store</p>
        </div>

        <div class="card">
          <div class="pricing-grid">
            <div class="pricing-card">
              <h4>Free</h4>
              <div class="pricing-price">$0<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Manual badge assignment</li>
                <li>HOT and NEW badges</li>
                <li>Up to 50 products</li>
                <li>Email support</li>
              </ul>
              <button class="btn btn-outline" style="width: 100%">
                Current Plan
              </button>
            </div>

            <div class="pricing-card featured">
              <div class="pricing-badge">Most Popular</div>
              <h4>Pro</h4>
              <div class="pricing-price">$9<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Everything in Free</li>
                <li>Auto SALE badge on discounts</li>
                <li>Unlimited products</li>
                <li>Priority support</li>
                <li>Custom badge styles</li>
              </ul>
              <button
                class="btn btn-primary"
                style="width: 100%"
                onclick="upgradePlan('pro')"
              >
                Upgrade to Pro
              </button>
            </div>

            <div class="pricing-card">
              <h4>Enterprise</h4>
              <div class="pricing-price">$29<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Everything in Pro</li>
                <li>Custom badge text</li>
                <li>A/B testing</li>
                <li>Analytics dashboard</li>
                <li>Dedicated account manager</li>
              </ul>
              <button
                class="btn btn-outline"
                style="width: 100%"
                onclick="upgradePlan('enterprise')"
              >
                Contact Sales
              </button>
            </div>
          </div>
        </div>
      </div>
<!-- HELP VIEW -->
<div id="help-view" class="view-section">
  <div class="page-header">
    <h2>Help & Support</h2>
    <p>Find answers to common questions and get assistance</p>
  </div>

  <div class="card">
    <h3>Need Assistance?</h3>
    <div class="contact-grid">
      <!-- Email Support -->
      <div class="contact-card">
        <div class="contact-icon">üìß</div>
        <h4>Email Support</h4>
        <p>Send us a detailed message</p>
        <button
          class="btn btn-primary"
          onclick="window.location.href='mailto:shopifyapps15@gmail.com'"
        >
          Email Us
        </button>
        <p style="margin-top: 8px; font-size: 13px; color: #6d7175;">shopifyapps15@gmail.com</p>
      </div>

      <!-- Documentation -->
      <div class="contact-card">
        <div class="contact-icon">üìö</div>
        <h4>Documentation</h4>
        <p>Setup guides and tutorials</p>
        <button
          class="btn btn-secondary"
          onclick="window.open('/privacy-policy', '_blank')"
        >
          View Docs
        </button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Frequently Asked Questions</h3>

    <!-- Setup & Installation -->
    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>How do I add badges to my theme?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        1. Click "Open Theme Editor" from the banner (or go to Online Store ‚Üí Themes ‚Üí Customize)<br />
        2. Navigate to your product page template<br />
        3. In the left sidebar, click "Add section" or "Add block"<br />
        4. Search for "Variant Badges" under the Apps section<br />
        5. Drag it into your product template where you want badges to appear<br />
        6. Click "Save" - badges will now show on your storefront!
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>Do badges work on all themes?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        Yes! Our app uses Shopify's Theme App Extension technology, which works universally on all themes including Dawn, Debut, Sense, and custom themes. You don't need to edit any theme code.
      </div>
    </div>

    <!-- Badge Assignment -->
    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>Can I assign badges to specific sizes or colors?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        Yes! Go to Settings and choose which option type (Color, Size, Material, etc.) you want to display badges on. Then in Manage Badges, assign badges to specific option values like "Black", "Large", or "Cotton".
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>Can I assign badges to all variants at once?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        Absolutely! When you assign a badge to "Black", it automatically applies to ALL variants with that option value (Black/Small, Black/Medium, Black/Large, etc.). This option-level assignment saves you from clicking dozens of times and makes badge management much faster.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>How do badges work with products that have multiple options?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        If your product has Color, Size, and Material options, you choose ONE option type in Settings to display badges on. For example, if you select "Color", badges will appear on color swatches (Black, Red, Blue) but not on size or material selectors. This prevents badge clutter and keeps your product pages clean.
      </div>
    </div>

    <!-- Badge Types -->
    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>What's the difference between HOT, NEW, and SALE badges?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        <strong>üî• HOT</strong> (red badge) - Use for trending, popular, or bestselling items to create urgency<br />
        <strong>‚ú® NEW</strong> (green badge) - Highlight recently added products or new arrivals<br />
        <strong>üí∞ SALE</strong> (orange badge) - Mark discounted items or special promotions<br /><br />
        You can assign these badges to any variant option based on your merchandising strategy.
      </div>
    </div>

    <!-- Troubleshooting -->
    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>Why aren't my badges showing on the storefront?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        Check these common issues:<br />
        1. <strong>App block not added:</strong> Check the banner at the top - if it shows, you need to add the app block to your theme<br />
        2. <strong>Display disabled:</strong> Go to Settings and make sure "Enable badge display" is checked<br />
        3. <strong>Wrong option type:</strong> Verify you've selected the correct option type (e.g., badges assigned to Color but Size is selected in Settings)<br />
        4. <strong>No badges assigned:</strong> Make sure you've actually assigned badges in the Manage Badges tab<br />
        5. <strong>Cache:</strong> Try viewing in incognito mode or clearing your browser cache
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>Can I preview badges before they go live?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        Yes! Click the "Preview ‚Üí" button next to any product in the Manage Badges tab. This opens your product page so you can see exactly how badges will look on your live storefront before customers see them.
      </div>
    </div>

    <!-- Data & Privacy -->
    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>What happens to my badges if I uninstall the app?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        All badge assignments and settings are automatically deleted when you uninstall the app. Your product data remains completely unchanged - we only store badge assignments, not your actual product information. You can reinstall anytime and start fresh.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(this)">
        <span>Do you store customer data?</span>
        <span class="faq-icon">‚ñº</span>
      </div>
      <div class="faq-answer">
        No. We don't collect, store, or access any customer personal information (names, emails, addresses, etc.). We only work with product variant information to display badges. See our <a href="/privacy-policy" target="_blank" style="color: #008060;">Privacy Policy</a> for details.
      </div>
    </div>

  </div>

  <!-- Contact Footer -->
  <div class="card" style="text-align: center; background: #f6f6f7;">
    <h4 style="margin-bottom: 8px;">Still need help?</h4>
    <p style="color: #6d7175; margin-bottom: 12px;">We're here to assist you!</p>
    <p>
      Email us at <a href="mailto:shopifyapps15@gmail.com" style="color: #008060; text-decoration: none; font-weight: 600;">shopifyapps15@gmail.com</a>
    </p>
    <p style="font-size: 13px; color: #999; margin-top: 8px;">We typically respond within 24 hours</p>
  </div>
</div>

    <script>
      // ============================================
      // CONFIGURATION
      // ============================================

      const SHOP = "{{SHOP}}";
      const API_KEY = "{{SHOPIFY_API_KEY}}";

      let sessionToken = null;
      let tokenExpiry = null;

      console.log("‚úÖ App loaded - Secure JWT authentication");

      // ============================================
      // TAB SWITCHING
      // ============================================

      function switchTab(tabName) {
        // Update tab UI
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update view
        document.querySelectorAll(".view-section").forEach((view) => {
          view.classList.remove("active");
        });
        document.getElementById(`${tabName}-view`).classList.add("active");

        // Load data for view
        if (tabName === "manage") {
          // Always reload products when switching to this tab (settings may have changed)
          console.log("üîÑ Loading products for Manage Badges tab");
          loadProducts();
        } else if (tabName === "settings" && !window.settingsLoaded) {
          loadSettings();
        }
      }

      // ============================================
      // JWT TOKEN MANAGEMENT
      // ============================================

      /**
       * Fetch a fresh session token from the server
       * Token is valid for 8 hours
       */
      async function getSessionToken(force = false) {
        // Return cached token if still valid
        if (!force && sessionToken && tokenExpiry && Date.now() < tokenExpiry) {
          return sessionToken;
        }

        try {
          console.log("üîë Fetching session token...");
          const response = await fetch(`/auth/token?shop=${SHOP}`);

          if (!response.ok) {
            const error = await response.json();
            console.error("‚ùå Token fetch failed:", error);

            // If not authenticated, redirect to OAuth
            if (response.status === 401 && error.redirect) {
              window.top.location.href = error.redirect;
              return null;
            }

            throw new Error(`Token fetch failed: ${response.status}`);
          }

          const data = await response.json();
          sessionToken = data.token;
          tokenExpiry = Date.now() + data.expiresIn * 1000 - 60 * 1000; // Expire 1 min early

          console.log("‚úÖ Session token obtained");
          return sessionToken;
        } catch (error) {
          console.error("‚ùå Failed to get session token:", error);
          throw error;
        }
      }

      /**
       * Make authenticated API calls with automatic token refresh
       */
      async function authenticatedFetch(url, options = {}, retryCount = 0) {
        try {
          // Get valid token
          const token = await getSessionToken();
          if (!token) {
            throw new Error("No session token available");
          }

          // Add Authorization header
          const headers = {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
            ...options.headers,
          };

          const response = await fetch(url, {
            ...options,
            headers,
          });

          // If 401 and we haven't retried, get fresh token and retry
          if (response.status === 401 && retryCount === 0) {
            console.log("üîÑ Token expired, refreshing...");
            await getSessionToken(true); // Force refresh
            return authenticatedFetch(url, options, retryCount + 1); // Retry once
          }

          return response;
        } catch (error) {
          console.error("‚ùå Authenticated fetch failed:", error);
          throw error;
        }
      }

      // ============================================
      // API CALLS
      // ============================================

      // ============================================
      // ONBOARDING BANNER
      // ============================================

      async function checkSetupStatus() {
        try {
          const response = await authenticatedFetch(
            `/api/setup/status?shop=${SHOP}`
          );

          if (!response.ok) {
            console.log("Setup check returned:", response.status);
            return;
          }

          const data = await response.json();

          if (!data.enabled) {
            document.getElementById("setup-banner").style.display = "block";
          }
        } catch (error) {
          console.log("Setup check skipped:", error.message);
        }
      }

      function openThemeEditor() {
        const url = `https://${SHOP}/admin/themes/current/editor?template=product`;
        window.open(url, "_blank");
      }

      function dismissBanner() {
        document.getElementById("setup-banner").style.display = "none";
      }

      checkSetupStatus();

      // ============================================
      // BADGE MANAGEMENT
      // ============================================

      async function loadProducts() {
        try {
          console.log("üì¶ Loading all products with badge assignments...");

          // First, check if option type is selected
          const settingsResponse = await authenticatedFetch(`/api/settings`);
          if (!settingsResponse.ok) {
            throw new Error("Failed to load settings");
          }

          const settings = await settingsResponse.json();
          const selectedOption = settings.selectedOption;

          if (!selectedOption) {
            // Show warning
            document.getElementById("no-option-warning").style.display =
              "block";
            document.getElementById("products-list-container").style.display =
              "none";
            window.productsLoaded = true;
            return;
          }

          // Hide warning, show products list
          document.getElementById("no-option-warning").style.display = "none";
          document.getElementById("products-list-container").style.display =
            "block";
          document.getElementById(
            "option-type-label"
          ).textContent = `Assigning badges to: ${selectedOption} variants`;

          // Show loading state
          document.getElementById("products-list").innerHTML =
            '<div class="loading">Loading products...</div>';

          // Fetch all products with their badge assignments
          const response = await authenticatedFetch(`/api/badges/all-products`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          renderAllProducts(data);

          window.productsLoaded = true;
          console.log(
            "‚úÖ Products loaded:",
            data.products ? data.products.length : 0
          );
        } catch (error) {
          console.error("Failed to load products:", error);
          document.getElementById("products-list").innerHTML =
            '<div class="error">Failed to load products. Please try again.</div>';
        }
      }

      function renderAllProducts(data) {
        const container = document.getElementById("products-list");

        if (!data.products || data.products.length === 0) {
          container.innerHTML =
            '<p style="color: #6d7175;">No products found with the selected option type.</p>';
          return;
        }

        let html = "";

        data.products.forEach((product) => {
          product.options.forEach((option) => {
            const currentBadge = option.badge || "none";
            console.log(
              "DEBUG: Rendering",
              option.optionValue,
              "- Badge from API:",
              option.badge,
              "- Using:",
              currentBadge
            );
            const productUrl = `https://${data.shop}/products/${product.handle}`;

            html += `
            <div class="badge-item" style="padding: 16px;">
              <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                <!-- Product Image -->
                <div style="flex-shrink: 0;">
                  <img src="${
                    option.imageUrl ||
                    product.imageUrl ||
                    "https://via.placeholder.com/60"
                  }" 
                       alt="${product.title}" 
                       style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #e1e3e5;">
                </div>
                
                <!-- Product Info -->
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${product.title}
                  </div>
                  <div style="color: #6d7175; font-size: 13px;">
                    ${data.selectedOption}: <strong>${
              option.optionValue
            }</strong> (${option.variantCount} variant${
              option.variantCount > 1 ? "s" : ""
            })
                  </div>
                  ${
                    currentBadge !== "none"
                      ? `<span class="badge-preview ${currentBadge}" style="margin-top: 6px; display: inline-block;">${currentBadge.toUpperCase()}</span>`
                      : ""
                  }
                </div>
              </div>
              
              <!-- Badge Dropdown & Preview -->
              <div style="display: flex; align-items: center; gap: 12px;">
                <select onchange="saveBadge('${product.id}', '${
              option.optionValue
            }', this.value)" 
                        style="width: 150px;">
                  <option value="none" ${
                    currentBadge === "none" ? "selected" : ""
                  }>No Badge</option>
                  <option value="hot" ${
                    currentBadge === "hot" ? "selected" : ""
                  }>üî• HOT</option>
                  <option value="new" ${
                    currentBadge === "new" ? "selected" : ""
                  }>‚ú® NEW</option>
                  <option value="sale" ${
                    currentBadge === "sale" ? "selected" : ""
                  }>üí∞ SALE</option>
                </select>
                <a href="${productUrl}" target="_blank" class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px; text-decoration: none;">
                  Preview ‚Üí
                </a>
              </div>
            </div>
          `;
          });
        });

        container.innerHTML = html;
      }

      async function saveBadge(productId, optionValue, badgeType) {
        try {
          console.log("üíæ Saving badge:", productId, optionValue, badgeType);

          const response = await authenticatedFetch("/api/badges", {
            method: "POST",
            body: JSON.stringify({
              productId,
              optionValue,
              badgeType,
            }),
          });

          if (response.ok) {
            console.log("‚úÖ Badge saved");
            // Refresh the products list to show updated badges
            loadProducts();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("Failed to save badge:", error);
          alert("Failed to save badge. Please try again.");
        }
      }

      // Load products on start
      loadProducts();

      // ============================================
      // SETTINGS
      // ============================================

      async function loadSettings() {
        try {
          // Load available options first
          const optionsResponse = await authenticatedFetch(
            "/api/products/options"
          );
          if (optionsResponse.ok) {
            const optionsData = await optionsResponse.json();
            const optionSelect = document.getElementById("option-type");

            // Clear existing options except the placeholder
            optionSelect.innerHTML =
              '<option value="">Select option type...</option>';

            // Add fetched options
            optionsData.options.forEach((optionName) => {
              const opt = document.createElement("option");
              opt.value = optionName;
              opt.textContent = optionName;
              optionSelect.appendChild(opt);
            });

            console.log("‚úÖ Loaded option types:", optionsData.options);
          }

          // Then load saved settings
          const response = await authenticatedFetch(`/api/settings`);

          if (!response.ok) {
            console.error("Failed to load settings, status:", response.status);
            return;
          }

          const settings = await response.json();

          document.getElementById("enable-display").checked =
            settings.enabled !== false;
          document.getElementById("option-type").value =
            settings.selectedOption || "";

          window.settingsLoaded = true;
          console.log("‚úÖ Settings loaded");
        } catch (error) {
          console.error("Failed to load settings:", error);
        }
      }

      async function saveSettings() {
        const enabled = document.getElementById("enable-display").checked;
        const selectedOption = document.getElementById("option-type").value;

        if (!selectedOption) {
          alert("Please select an option type");
          return;
        }

        try {
          const response = await authenticatedFetch("/api/settings", {
            method: "POST",
            body: JSON.stringify({
              enabled,
              selectedOption,
            }),
          });

          if (response.ok) {
            alert("‚úÖ Settings saved!");
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("Failed to save settings:", error);
          alert("Failed to save settings");
        }
      }

      // ============================================
      // PLANS
      // ============================================

      function upgradePlan(plan) {
        if (plan === "enterprise") {
          switchTab("help");
        } else {
          alert(
            `Upgrade to ${plan} plan - Shopify billing integration coming soon!`
          );
        }
      }

      // ============================================
      // HELP
      // ============================================

      function toggleFaq(element) {
        const answer = element.nextElementSibling;
        const icon = element.querySelector(".faq-icon");

        answer.classList.toggle("open");
        icon.classList.toggle("open");
      }

      function openLiveChat() {
        alert(
          "Live chat integration coming soon! For now, please email support@variantbadges.com"
        );
      }
    </script>
  </body>
</html>
