<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variant Badges</title>
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f6f6f7;
        color: #202223;
        line-height: 1.5;
      }

      /* Main Container */
      .app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      /* View Sections */
      .view-section {
        display: none;
      }
      .view-section.active {
        display: block;
      }

      /* Page Headers */
      .page-header {
        margin-bottom: 24px;
      }
      .page-header h1 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .page-header p {
        color: #6d7175;
        font-size: 14px;
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }
      .card h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
      }
      .card h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      /* Onboarding Banner */
      .banner {
        background: #fff9c4;
        border: 1px solid #f9a825;
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      .banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .banner-content {
        flex: 1;
      }
      .banner-content h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .banner-content p {
        font-size: 14px;
        color: #5c5c5c;
        margin-bottom: 12px;
      }
      .banner-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .banner-close {
        cursor: pointer;
        color: #666;
        font-size: 20px;
        flex-shrink: 0;
      }

      /* Buttons */
      .btn {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        text-decoration: none;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #008060;
        color: white;
      }
      .btn-primary:hover {
        background: #006e52;
      }
      .btn-secondary {
        background: white;
        color: #202223;
        border: 1px solid #c9cccf;
      }
      .btn-secondary:hover {
        background: #f6f6f7;
      }
      .btn-outline {
        background: transparent;
        color: #008060;
        border: 1px solid #008060;
      }
      .btn-outline:hover {
        background: #f0fdf9;
      }

      /* Form Elements */
      select,
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #c9cccf;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }
      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: #008060;
      }

      /* Toggle Switch */
      .toggle {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #c9cccf;
        transition: 0.3s;
        border-radius: 24px;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      .toggle input:checked + .toggle-slider {
        background-color: #008060;
      }
      .toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }

      /* Settings Row */
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid #e1e3e5;
      }
      .setting-row:last-child {
        border-bottom: none;
      }
      .setting-info h4 {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .setting-info p {
        font-size: 13px;
        color: #6d7175;
      }

      /* Badge Management */
      .product-selector {
        margin-bottom: 24px;
      }
      .badge-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .badge-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f6f6f7;
        border-radius: 6px;
      }
      .badge-item-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .badge-preview {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-preview.hot {
        background: #ff4444;
        color: white;
      }
      .badge-preview.new {
        background: #4caf50;
        color: white;
      }
      .badge-preview.sale {
        background: #ff9800;
        color: white;
      }

      /* Plans Page */
      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }
      .pricing-card {
        background: white;
        border: 2px solid #e1e3e5;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s;
      }
      .pricing-card:hover {
        border-color: #008060;
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .pricing-card.featured {
        border-color: #008060;
        position: relative;
      }
      .pricing-badge {
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: #008060;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }
      .pricing-card h3 {
        font-size: 24px;
        margin-bottom: 8px;
      }
      .pricing-price {
        font-size: 48px;
        font-weight: 700;
        color: #008060;
        margin: 16px 0;
      }
      .pricing-price span {
        font-size: 24px;
        color: #6d7175;
      }
      .pricing-features {
        list-style: none;
        margin: 24px 0;
        text-align: left;
      }
      .pricing-features li {
        padding: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pricing-features li:before {
        content: "‚úì";
        color: #008060;
        font-weight: bold;
      }

      /* Help/FAQ Page */
      .faq-item {
        border-bottom: 1px solid #e1e3e5;
        padding: 16px 0;
      }
      .faq-item:last-child {
        border-bottom: none;
      }
      .faq-question {
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
      }
      .faq-question:hover {
        color: #008060;
      }
      .faq-icon {
        transition: transform 0.3s;
      }
      .faq-icon.open {
        transform: rotate(180deg);
      }
      .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s;
        padding: 0 0 0 0;
        color: #6d7175;
        font-size: 14px;
        line-height: 1.6;
      }
      .faq-answer.open {
        max-height: 500px;
        padding: 12px 0;
      }
      .faq-answer code {
        background: #f6f6f7;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 13px;
      }

      /* Contact Support */
      .contact-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }
      .contact-card {
        background: #f6f6f7;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .contact-icon {
        font-size: 32px;
        margin-bottom: 12px;
      }
      .contact-card h4 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      .contact-card p {
        font-size: 14px;
        color: #6d7175;
        margin-bottom: 12px;
      }

      /* Loading States */
      .loading {
        text-align: center;
        padding: 40px;
        color: #6d7175;
      }
      .error {
        background: #ffebee;
        border: 1px solid #ef5350;
        color: #c62828;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
      }
      .success {
        background: #e8f5e9;
        border: 1px solid #66bb6a;
        color: #2e7d32;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .app-container {
          padding: 16px;
        }
        .pricing-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Onboarding Banner (shows on all pages until dismissed) -->
      <div id="setup-banner" style="display: none">
        <div class="banner">
          <div class="banner-icon">‚ö†Ô∏è</div>
          <div class="banner-content">
            <h3>Complete Setup (30 seconds)</h3>
            <p>
              Badges are ready! Add them to your theme to make them visible to
              customers.
            </p>
            <div class="banner-actions">
              <button class="btn btn-primary" onclick="openThemeEditor()">
                üé® Open Theme Editor
              </button>
              <button class="btn btn-secondary" onclick="showTutorial()">
                üì∫ Watch Tutorial
              </button>
              <button class="btn btn-outline" onclick="dismissBanner()">
                Dismiss
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MANAGE BADGES VIEW -->
      <div id="manage-view" class="view-section">
        <div class="page-header">
          <h1>üìõ Manage Badges</h1>
          <p>Assign HOT, NEW, and SALE badges to product variants</p>
        </div>

        <div class="card">
          <h2>Select Product</h2>
          <div class="product-selector">
            <select id="product-select" onchange="loadProductBadges()">
              <option value="">Loading products...</option>
            </select>
          </div>
        </div>

        <div id="badges-container" class="card" style="display: none">
          <h2>Assign Badges</h2>
          <div id="badges-list" class="badge-list"></div>
        </div>
      </div>

      <!-- SETTINGS VIEW -->
      <div id="settings-view" class="view-section">
        <div class="page-header">
          <h1>‚öôÔ∏è Settings</h1>
          <p>Configure your badge display preferences</p>
        </div>

        <div class="card">
          <h2>Badge Display</h2>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Enable Badge Display</h4>
              <p>Badges appear on variant swatches when enabled</p>
            </div>
            <label class="toggle">
              <input type="checkbox" id="enable-display" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Select variant type you want to apply badges to:</h4>
              <p>
                Choose which product option (Color, Size, etc.) will display
                badges
              </p>
            </div>
            <select id="option-type" style="width: 200px">
              <option value="">Select an option type...</option>
              <option value="Color">Color</option>
              <option value="Size">Size</option>
              <option value="Style">Style</option>
              <option value="Material">Material</option>
            </select>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Automatically display SALE badge on discounted variants</h4>
              <p style="color: #f9a825">
                <strong>üîí PREMIUM</strong> - SALE badges override manual
                selections
              </p>
            </div>
            <label class="toggle">
              <input type="checkbox" id="auto-sale" disabled />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <button class="btn btn-primary" onclick="saveSettings()">
            Save Settings
          </button>
        </div>
      </div>

      <!-- PLANS VIEW -->
      <div id="plans-view" class="view-section">
        <div class="page-header">
          <h1>üí≥ Plans & Pricing</h1>
          <p>Choose the plan that fits your store</p>
        </div>

        <div class="card">
          <div class="pricing-grid">
            <!-- Free Plan -->
            <div class="pricing-card">
              <h3>Free</h3>
              <div class="pricing-price">$0<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Manual badge assignment</li>
                <li>HOT and NEW badges</li>
                <li>Up to 50 products</li>
                <li>Email support</li>
              </ul>
              <button class="btn btn-outline" style="width: 100%">
                Current Plan
              </button>
            </div>

            <!-- Pro Plan -->
            <div class="pricing-card featured">
              <div class="pricing-badge">Most Popular</div>
              <h3>Pro</h3>
              <div class="pricing-price">$9<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Everything in Free</li>
                <li>Auto SALE badge on discounts</li>
                <li>Unlimited products</li>
                <li>Priority support</li>
                <li>Custom badge styles</li>
              </ul>
              <button
                class="btn btn-primary"
                style="width: 100%"
                onclick="upgradePlan('pro')"
              >
                Upgrade to Pro
              </button>
            </div>

            <!-- Enterprise Plan -->
            <div class="pricing-card">
              <h3>Enterprise</h3>
              <div class="pricing-price">$29<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Everything in Pro</li>
                <li>Custom badge text</li>
                <li>A/B testing</li>
                <li>Analytics dashboard</li>
                <li>Dedicated account manager</li>
              </ul>
              <button
                class="btn btn-outline"
                style="width: 100%"
                onclick="upgradePlan('enterprise')"
              >
                Contact Sales
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üí° Need help choosing?</h3>
          <p style="margin-top: 12px">
            Not sure which plan is right for you?
            <a
              href="/app/help"
              style="color: #008060; text-decoration: none; font-weight: 600"
              >Contact our team</a
            >
            and we'll help you decide.
          </p>
        </div>
      </div>

      <!-- HELP VIEW -->
      <div id="help-view" class="view-section">
        <div class="page-header">
          <h1>‚ùì Help & Support</h1>
          <p>Find answers to common questions</p>
        </div>

        <!-- Contact Support -->
        <div class="card">
          <h2>Need Assistance?</h2>
          <div class="contact-grid">
            <div class="contact-card">
              <div class="contact-icon">üí¨</div>
              <h4>Live Chat</h4>
              <p>Get instant help from our support team</p>
              <button class="btn btn-primary" onclick="openLiveChat()">
                Start Chat
              </button>
            </div>
            <div class="contact-card">
              <div class="contact-icon">üìß</div>
              <h4>Email Support</h4>
              <p>Send us a detailed message</p>
              <button
                class="btn btn-secondary"
                onclick="window.location.href='mailto:support@variantbadges.com'"
              >
                Email Us
              </button>
            </div>
            <div class="contact-card">
              <div class="contact-icon">üìö</div>
              <h4>Documentation</h4>
              <p>Browse our knowledge base</p>
              <button
                class="btn btn-secondary"
                onclick="window.open('https://docs.variantbadges.com', '_blank')"
              >
                View Docs
              </button>
            </div>
          </div>
        </div>

        <!-- FAQ Section -->
        <div class="card">
          <h2>Frequently Asked Questions</h2>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>How do I add badges to my theme?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              1. Click "Open Theme Editor" from the banner<br />
              2. In the left sidebar, click "Add section" or "Add block"<br />
              3. Find "Variant Badges Display" under Apps<br />
              4. Drag it into your product template<br />
              5. Click "Save" - badges will now appear on your store!
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>How do badges work with multiple options?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              If your product has Color, Size, and Material options, go to
              Settings and select which option type should display badges. For
              example, if you choose "Color", badges will appear on color
              swatches (Black, Red, Blue) but not on size selectors.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>Can I assign badges to all variants at once?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              Yes! When you assign a badge to "Black", it automatically applies
              to ALL Black variants (Small, Medium, Large, XL). This saves you
              from clicking dozens of times.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>Why aren't my badges showing on the storefront?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              Common issues:<br />
              1. App block not added to theme (check the banner)<br />
              2. Badge display is disabled in Settings<br />
              3. Wrong option type selected (badges on Color but you chose
              Size)<br />
              4. Cache - try clearing browser cache or incognito mode
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span
                >What's the difference between HOT, NEW, and SALE badges?</span
              >
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              <strong>HOT</strong> (red) - Trending or popular items<br />
              <strong>NEW</strong> (green) - Recently added products<br />
              <strong>SALE</strong> (orange) - Discounted items (Pro plan
              auto-applies this)
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>How do I upgrade to Pro?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              Go to the Plans tab and click "Upgrade to Pro". You'll be
              redirected to Shopify's billing page to confirm. Billing is
              handled securely through Shopify.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>Will this slow down my store?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              No! Badges are cached for 5 minutes and load asynchronously. The
              JavaScript is only 5KB minified. Most stores see no measurable
              performance impact.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>Can I customize badge colors and styles?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              Custom styling is available on the Pro and Enterprise plans.
              Contact support with your requirements and we'll help you match
              your brand.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // APP BRIDGE INITIALIZATION
      // ============================================

      let appBridge = null;
      const SHOP = "{{SHOP}}";
      const API_KEY = "{{SHOPIFY_API_KEY}}";
      const HOST = new URLSearchParams(window.location.search).get("host");
      const CURRENT_VIEW = "{{VIEW}}";

      async function initAppBridge() {
        try {
          // Wait for App Bridge library to load (with retry)
          let attempts = 0;
          while (!window.ShopifyApp && attempts < 50) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }

          if (!window.ShopifyApp) {
            console.error("‚ùå App Bridge library not loaded after 5 seconds");
            return false;
          }

          console.log("‚úÖ ShopifyApp found");

          // Create app instance
          appBridge = window.ShopifyApp.createApp({
            apiKey: API_KEY,
            host: HOST,
            forceRedirect: true,
          });

          console.log("‚úÖ App Bridge initialized");

          // Create Navigation Menu - THIS ADDS LEFT SIDEBAR LINKS
          const NavigationMenu = window.ShopifyApp.NavigationMenu;
          NavigationMenu.create(appBridge, {
            items: [
              {
                label: "Variant Badges",
                destination: `/app?shop=${SHOP}&host=${HOST}`,
              },
              {
                label: "Settings",
                destination: `/app/settings?shop=${SHOP}&host=${HOST}`,
              },
              {
                label: "Plans",
                destination: `/app/plans?shop=${SHOP}&host=${HOST}`,
              },
              {
                label: "Help",
                destination: `/app/help?shop=${SHOP}&host=${HOST}`,
              },
            ],
          });

          console.log("‚úÖ Navigation menu created");
          return true;
        } catch (error) {
          console.error("‚ùå App Bridge failed:", error);
          return false;
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          initAppBridge().then(() => {
            console.log("‚úÖ App ready");
          });
        });
      } else {
        initAppBridge().then(() => {
          console.log("‚úÖ App ready");
        });
      }

      // ============================================
      // VIEW SWITCHING
      // ============================================

      function showView(viewName) {
        // Hide all views
        document.querySelectorAll(".view-section").forEach((view) => {
          view.classList.remove("active");
        });

        // Show selected view
        const targetView = document.getElementById(`${viewName}-view`);
        if (targetView) {
          targetView.classList.add("active");
        }
      }

      // Show the current view based on server parameter
      showView(CURRENT_VIEW);

      // ============================================
      // SESSION TOKEN HELPER
      // ============================================

      async function getSessionToken() {
        // Wait for App Bridge to be initialized
        let attempts = 0;
        while (!appBridge && attempts < 50) {
          await new Promise((resolve) => setTimeout(resolve, 100));
          attempts++;
        }

        if (!appBridge) {
          throw new Error("App Bridge not initialized");
        }

        try {
          // Get session token using App Bridge 2 API
          const token = await appBridge.getSessionToken();
          console.log("‚úÖ Got session token");
          return token;
        } catch (error) {
          console.error("‚ùå Failed to get session token:", error);
          throw error;
        }
      }

      async function authenticatedFetch(url, options = {}) {
        const token = await getSessionToken();
        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
          ...options.headers,
        };

        return fetch(url, {
          ...options,
          headers,
        });
      }

      // ============================================
      // ONBOARDING BANNER
      // ============================================

      async function checkSetupStatus() {
        try {
          const response = await authenticatedFetch(
            `/api/setup/status?shop=${SHOP}`
          );
          const data = await response.json();

          if (!data.enabled) {
            document.getElementById("setup-banner").style.display = "block";
          }
        } catch (error) {
          console.error("Setup check failed:", error);
        }
      }

      function openThemeEditor() {
        const url = `https://${SHOP}/admin/themes/current/editor?context=apps`;
        window.open(url, "_blank");
      }

      function showTutorial() {
        alert(
          "Tutorial video coming soon! For now, click 'Open Theme Editor' and add the Variant Badges block."
        );
      }

      function dismissBanner() {
        document.getElementById("setup-banner").style.display = "none";
      }

      // Will check setup status after App Bridge loads

      // ============================================
      // BADGE MANAGEMENT (Manage View)
      // ============================================

      async function loadProducts() {
        try {
          const response = await authenticatedFetch(
            `/api/products/list?shop=${SHOP}`
          );
          const products = await response.json();

          const select = document.getElementById("product-select");
          select.innerHTML = '<option value="">Select a product...</option>';

          products.forEach((product) => {
            const option = document.createElement("option");
            option.value = product.id;
            option.textContent = product.title;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Failed to load products:", error);
        }
      }

      async function loadProductBadges() {
        const productId = document.getElementById("product-select").value;
        if (!productId) return;

        // Show loading state
        document.getElementById("badges-container").style.display = "block";
        document.getElementById("badges-list").innerHTML =
          '<div class="loading">Loading badges...</div>';

        try {
          const response = await authenticatedFetch(
            `/api/badges?shop=${SHOP}&productId=${productId}`
          );
          const data = await response.json();

          renderBadges(data);
        } catch (error) {
          console.error("Failed to load badges:", error);
          document.getElementById("badges-list").innerHTML =
            '<div class="error">Failed to load badges</div>';
        }
      }

      function renderBadges(data) {
        const container = document.getElementById("badges-list");

        if (!data.options || data.options.length === 0) {
          container.innerHTML =
            '<p style="color: #6d7175;">No variants found for this product.</p>';
          return;
        }

        let html = "";
        data.options.forEach((option) => {
          const currentBadge = option.badge || "none";

          html += `
          <div class="badge-item">
            <div class="badge-item-info">
              <span><strong>${option.optionValue}</strong> (${
            option.variantCount
          } variants)</span>
              ${
                currentBadge !== "none"
                  ? `<span class="badge-preview ${currentBadge}">${currentBadge}</span>`
                  : ""
              }
            </div>
            <select onchange="saveBadge('${option.optionValue}', this.value)">
              <option value="none" ${
                currentBadge === "none" ? "selected" : ""
              }>No Badge</option>
              <option value="hot" ${
                currentBadge === "hot" ? "selected" : ""
              }>HOT</option>
              <option value="new" ${
                currentBadge === "new" ? "selected" : ""
              }>NEW</option>
              <option value="sale" ${
                currentBadge === "sale" ? "selected" : ""
              }>SALE</option>
            </select>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      async function saveBadge(optionValue, badgeType) {
        const productId = document.getElementById("product-select").value;

        try {
          const response = await authenticatedFetch("/api/badges", {
            method: "POST",
            body: JSON.stringify({
              shop: SHOP,
              productId,
              optionValue,
              badgeType,
            }),
          });

          if (response.ok) {
            console.log("‚úÖ Badge saved");
            // Reload to show updated state
            loadProductBadges();
          }
        } catch (error) {
          console.error("Failed to save badge:", error);
          alert("Failed to save badge");
        }
      }

      // Load products if on manage view
      if (CURRENT_VIEW === "manage") {
        loadProducts();
      }

      // ============================================
      // SETTINGS (Settings View)
      // ============================================

      async function loadSettings() {
        try {
          const response = await authenticatedFetch(
            `/api/settings?shop=${SHOP}`
          );
          const settings = await response.json();

          document.getElementById("enable-display").checked =
            settings.enabled !== false;
          document.getElementById("option-type").value =
            settings.selectedOption || "";
        } catch (error) {
          console.error("Failed to load settings:", error);
        }
      }

      async function saveSettings() {
        const enabled = document.getElementById("enable-display").checked;
        const selectedOption = document.getElementById("option-type").value;

        if (!selectedOption) {
          alert("Please select an option type");
          return;
        }

        try {
          const response = await authenticatedFetch("/api/settings", {
            method: "POST",
            body: JSON.stringify({
              shop: SHOP,
              enabled,
              selectedOption,
            }),
          });

          if (response.ok) {
            alert("‚úÖ Settings saved!");
          }
        } catch (error) {
          console.error("Failed to save settings:", error);
          alert("Failed to save settings");
        }
      }

      // Load settings if on settings view
      if (CURRENT_VIEW === "settings") {
        loadSettings();
      }

      // ============================================
      // PLANS (Plans View)
      // ============================================

      function upgradePlan(plan) {
        if (plan === "enterprise") {
          window.location.href = `/app/help?shop=${SHOP}&host=${HOST}`;
        } else {
          alert(
            `Upgrade to ${plan} plan - Shopify billing integration coming soon!`
          );
          // TODO: Implement Shopify billing API
        }
      }

      // ============================================
      // HELP (Help View)
      // ============================================

      function toggleFaq(element) {
        const answer = element.nextElementSibling;
        const icon = element.querySelector(".faq-icon");

        answer.classList.toggle("open");
        icon.classList.toggle("open");
      }

      function openLiveChat() {
        alert(
          "Live chat integration coming soon! For now, please email support@variantbadges.com"
        );
        // TODO: Integrate with chat service (Intercom, Zendesk, etc.)
      }
    </script>
  </body>
</html>
