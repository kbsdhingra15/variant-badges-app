<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variant Badges</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f6f6f7;
        color: #202223;
        line-height: 1.5;
      }

      /* Header */
      .app-header {
        background: white;
        border-bottom: 1px solid #e1e3e5;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .app-header h1 {
        font-size: 20px;
        font-weight: 600;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 4px;
        background: white;
        border-bottom: 1px solid #e1e3e5;
        padding: 0 24px;
      }
      .tab {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: #6d7175;
        font-weight: 500;
        transition: all 0.2s;
      }
      .tab:hover {
        color: #202223;
        background: #f6f6f7;
      }
      .tab.active {
        color: #008060;
        border-bottom-color: #008060;
      }

      /* Main Container */
      .app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      /* View Sections */
      .view-section {
        display: none;
      }
      .view-section.active {
        display: block;
      }

      /* Page Headers */
      .page-header {
        margin-bottom: 24px;
      }
      .page-header h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .page-header p {
        color: #6d7175;
        font-size: 14px;
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }
      .card h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      /* Banner */
      .banner {
        background: #fff9c4;
        border: 1px solid #f9a825;
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      .banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .banner-content {
        flex: 1;
      }
      .banner-content h4 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .banner-content p {
        font-size: 14px;
        color: #5c5c5c;
        margin-bottom: 12px;
      }
      .banner-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Buttons */
      .btn {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        text-decoration: none;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #008060;
        color: white;
      }
      .btn-primary:hover {
        background: #006e52;
      }
      .btn-secondary {
        background: white;
        color: #202223;
        border: 1px solid #c9cccf;
      }
      .btn-secondary:hover {
        background: #f6f6f7;
      }
      .btn-outline {
        background: transparent;
        color: #008060;
        border: 1px solid #008060;
      }
      .btn-outline:hover {
        background: #f0fdf9;
      }

      /* Form Elements */
      select,
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #c9cccf;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      /* Toggle */
      .toggle {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #c9cccf;
        transition: 0.3s;
        border-radius: 24px;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      .toggle input:checked + .toggle-slider {
        background-color: #008060;
      }
      .toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }

      /* Settings Row */
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid #e1e3e5;
      }
      .setting-row:last-child {
        border-bottom: none;
      }
      .setting-info h4 {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .setting-info p {
        font-size: 13px;
        color: #6d7175;
      }

      /* Badge List */
      .badge-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .badge-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f6f6f7;
        border-radius: 6px;
      }
      .badge-item-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .badge-preview {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-preview.hot {
        background: #ff4444;
        color: white;
      }
      .badge-preview.new {
        background: #4caf50;
        color: white;
      }
      .badge-preview.sale {
        background: #ff9800;
        color: white;
      }

      /* Pricing Grid */
      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }
      .pricing-card {
        background: white;
        border: 2px solid #e1e3e5;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s;
      }
      .pricing-card:hover {
        border-color: #008060;
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .pricing-card.featured {
        border-color: #008060;
        position: relative;
      }
      .pricing-badge {
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: #008060;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }
      .pricing-card h4 {
        font-size: 24px;
        margin-bottom: 8px;
      }
      .pricing-price {
        font-size: 48px;
        font-weight: 700;
        color: #008060;
        margin: 16px 0;
      }
      .pricing-price span {
        font-size: 24px;
        color: #6d7175;
      }
      .pricing-features {
        list-style: none;
        margin: 24px 0;
        text-align: left;
      }
      .pricing-features li {
        padding: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pricing-features li:before {
        content: "‚úì";
        color: #008060;
        font-weight: bold;
      }

      /* FAQ */
      .faq-item {
        border-bottom: 1px solid #e1e3e5;
        padding: 16px 0;
      }
      .faq-item:last-child {
        border-bottom: none;
      }
      .faq-question {
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
      }
      .faq-question:hover {
        color: #008060;
      }
      .faq-icon {
        transition: transform 0.3s;
      }
      .faq-icon.open {
        transform: rotate(180deg);
      }
      .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s;
        padding: 0;
        color: #6d7175;
        font-size: 14px;
        line-height: 1.6;
      }
      .faq-answer.open {
        max-height: 500px;
        padding: 12px 0;
      }

      /* Contact Grid */
      .contact-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }
      .contact-card {
        background: #f6f6f7;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .contact-icon {
        font-size: 32px;
        margin-bottom: 12px;
      }
      .contact-card h4 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      .contact-card p {
        font-size: 14px;
        color: #6d7175;
        margin-bottom: 12px;
      }

      /* Loading & Messages */
      .loading {
        text-align: center;
        padding: 40px;
        color: #6d7175;
      }
      .error {
        background: #ffebee;
        border: 1px solid #ef5350;
        color: #c62828;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
      }
      .success {
        background: #e8f5e9;
        border: 1px solid #66bb6a;
        color: #2e7d32;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .app-container {
          padding: 16px;
        }
        .tabs {
          overflow-x: auto;
        }
        .pricing-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- App Header -->
    <div class="app-header">
      <span style="font-size: 24px">üìõ</span>
      <h1>Variant Badges</h1>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('manage')">Manage Badges</div>
      <div class="tab" onclick="switchTab('settings')">Settings</div>
      <div class="tab" onclick="switchTab('plans')">Plans</div>
      <div class="tab" onclick="switchTab('help')">Help</div>
    </div>

    <div class="app-container">
      <!-- Onboarding Banner -->
      <div id="setup-banner" style="display: none">
        <div class="banner">
          <div class="banner-icon">‚ö†Ô∏è</div>
          <div class="banner-content">
            <h4>Complete Setup (30 seconds)</h4>
            <p>
              Badges are ready! Add them to your theme to make them visible to
              customers.
            </p>
            <div class="banner-actions">
              <button class="btn btn-primary" onclick="openThemeEditor()">
                üé® Open Theme Editor
              </button>
              <button class="btn btn-outline" onclick="dismissBanner()">
                Dismiss
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MANAGE BADGES VIEW -->
      <div id="manage-view" class="view-section active">
        <div class="page-header">
          <h2>Manage Badges</h2>
          <p>Assign HOT, NEW, and SALE badges to product variants</p>
        </div>

        <div class="card">
          <h3>Select Product</h3>
          <select id="product-select" onchange="loadProductBadges()">
            <option value="">Loading products...</option>
          </select>
        </div>

        <div id="badges-container" class="card" style="display: none">
          <h3>Assign Badges</h3>
          <div id="badges-list" class="badge-list"></div>
        </div>
      </div>

      <!-- SETTINGS VIEW -->
      <div id="settings-view" class="view-section">
        <div class="page-header">
          <h2>Settings</h2>
          <p>Configure your badge display preferences</p>
        </div>

        <div class="card">
          <h3>Badge Display</h3>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Enable Badge Display</h4>
              <p>Badges appear on variant swatches when enabled</p>
            </div>
            <label class="toggle">
              <input type="checkbox" id="enable-display" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Select variant type you want to apply badges to:</h4>
              <p>
                Choose which product option (Color, Size, etc.) will display
                badges
              </p>
            </div>
            <select id="option-type" style="width: 200px">
              <option value="">Select an option type...</option>
              <option value="Color">Color</option>
              <option value="Size">Size</option>
              <option value="Style">Style</option>
              <option value="Material">Material</option>
            </select>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <h4>Automatically display SALE badge on discounted variants</h4>
              <p style="color: #f9a825">
                <strong>üîí PREMIUM</strong> - SALE badges override manual
                selections
              </p>
            </div>
            <label class="toggle">
              <input type="checkbox" id="auto-sale" disabled />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <button class="btn btn-primary" onclick="saveSettings()">
            Save Settings
          </button>
        </div>
      </div>

      <!-- PLANS VIEW -->
      <div id="plans-view" class="view-section">
        <div class="page-header">
          <h2>Plans & Pricing</h2>
          <p>Choose the plan that fits your store</p>
        </div>

        <div class="card">
          <div class="pricing-grid">
            <div class="pricing-card">
              <h4>Free</h4>
              <div class="pricing-price">$0<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Manual badge assignment</li>
                <li>HOT and NEW badges</li>
                <li>Up to 50 products</li>
                <li>Email support</li>
              </ul>
              <button class="btn btn-outline" style="width: 100%">
                Current Plan
              </button>
            </div>

            <div class="pricing-card featured">
              <div class="pricing-badge">Most Popular</div>
              <h4>Pro</h4>
              <div class="pricing-price">$9<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Everything in Free</li>
                <li>Auto SALE badge on discounts</li>
                <li>Unlimited products</li>
                <li>Priority support</li>
                <li>Custom badge styles</li>
              </ul>
              <button
                class="btn btn-primary"
                style="width: 100%"
                onclick="upgradePlan('pro')"
              >
                Upgrade to Pro
              </button>
            </div>

            <div class="pricing-card">
              <h4>Enterprise</h4>
              <div class="pricing-price">$29<span>/mo</span></div>
              <ul class="pricing-features">
                <li>Everything in Pro</li>
                <li>Custom badge text</li>
                <li>A/B testing</li>
                <li>Analytics dashboard</li>
                <li>Dedicated account manager</li>
              </ul>
              <button
                class="btn btn-outline"
                style="width: 100%"
                onclick="upgradePlan('enterprise')"
              >
                Contact Sales
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- HELP VIEW -->
      <div id="help-view" class="view-section">
        <div class="page-header">
          <h2>Help & Support</h2>
          <p>Find answers to common questions</p>
        </div>

        <div class="card">
          <h3>Need Assistance?</h3>
          <div class="contact-grid">
            <div class="contact-card">
              <div class="contact-icon">üí¨</div>
              <h4>Live Chat</h4>
              <p>Get instant help from our support team</p>
              <button class="btn btn-primary" onclick="openLiveChat()">
                Start Chat
              </button>
            </div>
            <div class="contact-card">
              <div class="contact-icon">üìß</div>
              <h4>Email Support</h4>
              <p>Send us a detailed message</p>
              <button
                class="btn btn-secondary"
                onclick="window.location.href='mailto:support@variantbadges.com'"
              >
                Email Us
              </button>
            </div>
            <div class="contact-card">
              <div class="contact-icon">üìö</div>
              <h4>Documentation</h4>
              <p>Browse our knowledge base</p>
              <button
                class="btn btn-secondary"
                onclick="window.open('https://docs.variantbadges.com', '_blank')"
              >
                View Docs
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Frequently Asked Questions</h3>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>How do I add badges to my theme?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              1. Click "Open Theme Editor" from the banner<br />
              2. In the left sidebar, click "Add section" or "Add block"<br />
              3. Find "Variant Badges Display" under Apps<br />
              4. Drag it into your product template<br />
              5. Click "Save" - badges will now appear on your store!
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>How do badges work with multiple options?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              If your product has Color, Size, and Material options, go to
              Settings and select which option type should display badges. For
              example, if you choose "Color", badges will appear on color
              swatches (Black, Red, Blue) but not on size selectors.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>Can I assign badges to all variants at once?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              Yes! When you assign a badge to "Black", it automatically applies
              to ALL Black variants (Small, Medium, Large, XL). This saves you
              from clicking dozens of times.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span>Why aren't my badges showing on the storefront?</span>
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              Common issues:<br />
              1. App block not added to theme (check the banner)<br />
              2. Badge display is disabled in Settings<br />
              3. Wrong option type selected (badges on Color but you chose
              Size)<br />
              4. Cache - try clearing browser cache or incognito mode
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
              <span
                >What's the difference between HOT, NEW, and SALE badges?</span
              >
              <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
              <strong>HOT</strong> (red) - Trending or popular items<br />
              <strong>NEW</strong> (green) - Recently added products<br />
              <strong>SALE</strong> (orange) - Discounted items (Pro plan
              auto-applies this)
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // CONFIGURATION
      // ============================================

      const SHOP = "{{SHOP}}";
      const API_KEY = "{{SHOPIFY_API_KEY}}";

      let sessionToken = null;
      let tokenExpiry = null;

      console.log("‚úÖ App loaded - Secure JWT authentication");

      // ============================================
      // TAB SWITCHING
      // ============================================

      function switchTab(tabName) {
        // Update tab UI
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update view
        document.querySelectorAll(".view-section").forEach((view) => {
          view.classList.remove("active");
        });
        document.getElementById(`${tabName}-view`).classList.add("active");

        // Load data for view
        if (tabName === "manage" && !window.productsLoaded) {
          loadProducts();
        } else if (tabName === "settings" && !window.settingsLoaded) {
          loadSettings();
        }
      }

      // ============================================
      // JWT TOKEN MANAGEMENT
      // ============================================

      /**
       * Fetch a fresh session token from the server
       * Token is valid for 8 hours
       */
      async function getSessionToken(force = false) {
        // Return cached token if still valid
        if (!force && sessionToken && tokenExpiry && Date.now() < tokenExpiry) {
          return sessionToken;
        }

        try {
          console.log("üîë Fetching session token...");
          const response = await fetch(`/auth/token?shop=${SHOP}`);

          if (!response.ok) {
            const error = await response.json();
            console.error("‚ùå Token fetch failed:", error);

            // If not authenticated, redirect to OAuth
            if (response.status === 401 && error.redirect) {
              window.top.location.href = error.redirect;
              return null;
            }

            throw new Error(`Token fetch failed: ${response.status}`);
          }

          const data = await response.json();
          sessionToken = data.token;
          tokenExpiry = Date.now() + data.expiresIn * 1000 - 60 * 1000; // Expire 1 min early

          console.log("‚úÖ Session token obtained");
          return sessionToken;
        } catch (error) {
          console.error("‚ùå Failed to get session token:", error);
          throw error;
        }
      }

      /**
       * Make authenticated API calls with automatic token refresh
       */
      async function authenticatedFetch(url, options = {}, retryCount = 0) {
        try {
          // Get valid token
          const token = await getSessionToken();
          if (!token) {
            throw new Error("No session token available");
          }

          // Add Authorization header
          const headers = {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
            ...options.headers,
          };

          const response = await fetch(url, {
            ...options,
            headers,
          });

          // If 401 and we haven't retried, get fresh token and retry
          if (response.status === 401 && retryCount === 0) {
            console.log("üîÑ Token expired, refreshing...");
            await getSessionToken(true); // Force refresh
            return authenticatedFetch(url, options, retryCount + 1); // Retry once
          }

          return response;
        } catch (error) {
          console.error("‚ùå Authenticated fetch failed:", error);
          throw error;
        }
      }

      // ============================================
      // API CALLS
      // ============================================

      // ============================================
      // ONBOARDING BANNER
      // ============================================

      async function checkSetupStatus() {
        try {
          const response = await authenticatedFetch(
            `/api/setup/status?shop=${SHOP}`
          );

          if (!response.ok) {
            console.log("Setup check returned:", response.status);
            return;
          }

          const data = await response.json();

          if (!data.enabled) {
            document.getElementById("setup-banner").style.display = "block";
          }
        } catch (error) {
          console.log("Setup check skipped:", error.message);
        }
      }

      function openThemeEditor() {
        const url = `https://${SHOP}/admin/themes/current/editor?context=apps`;
        window.open(url, "_blank");
      }

      function dismissBanner() {
        document.getElementById("setup-banner").style.display = "none";
      }

      checkSetupStatus();

      // ============================================
      // BADGE MANAGEMENT
      // ============================================

      async function loadProducts() {
        try {
          const response = await authenticatedFetch(`/api/products/list`);

          if (!response.ok) {
            console.error("Failed to load products, status:", response.status);
            const select = document.getElementById("product-select");
            select.innerHTML =
              '<option value="">Error loading products - check console</option>';
            return;
          }

          const products = await response.json();

          const select = document.getElementById("product-select");
          select.innerHTML = '<option value="">Select a product...</option>';

          if (!products || !Array.isArray(products)) {
            console.error("Invalid products response:", products);
            select.innerHTML = '<option value="">No products found</option>';
            return;
          }

          products.forEach((product) => {
            const option = document.createElement("option");
            option.value = product.id;
            option.textContent = product.title;
            select.appendChild(option);
          });

          window.productsLoaded = true;
          console.log("‚úÖ Products loaded:", products.length);
        } catch (error) {
          console.error("Failed to load products:", error);
          document.getElementById("product-select").innerHTML =
            '<option value="">Error loading products</option>';
        }
      }

      async function loadProductBadges() {
        const productId = document.getElementById("product-select").value;
        if (!productId) return;

        document.getElementById("badges-container").style.display = "block";
        document.getElementById("badges-list").innerHTML =
          '<div class="loading">Loading badges...</div>';

        try {
          const response = await authenticatedFetch(
            `/api/badges?productId=${productId}`
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          renderBadges(data);
        } catch (error) {
          console.error("Failed to load badges:", error);
          document.getElementById("badges-list").innerHTML =
            '<div class="error">Failed to load badges</div>';
        }
      }

      function renderBadges(data) {
        const container = document.getElementById("badges-list");

        if (!data.options || data.options.length === 0) {
          container.innerHTML =
            '<p style="color: #6d7175;">No variants found for this product.</p>';
          return;
        }

        let html = "";
        data.options.forEach((option) => {
          const currentBadge = option.badge || "none";

          html += `
          <div class="badge-item">
            <div class="badge-item-info">
              <span><strong>${option.optionValue}</strong> (${
            option.variantCount
          } variants)</span>
              ${
                currentBadge !== "none"
                  ? `<span class="badge-preview ${currentBadge}">${currentBadge}</span>`
                  : ""
              }
            </div>
            <select onchange="saveBadge('${option.optionValue}', this.value)">
              <option value="none" ${
                currentBadge === "none" ? "selected" : ""
              }>No Badge</option>
              <option value="hot" ${
                currentBadge === "hot" ? "selected" : ""
              }>HOT</option>
              <option value="new" ${
                currentBadge === "new" ? "selected" : ""
              }>NEW</option>
              <option value="sale" ${
                currentBadge === "sale" ? "selected" : ""
              }>SALE</option>
            </select>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      async function saveBadge(optionValue, badgeType) {
        const productId = document.getElementById("product-select").value;

        try {
          const response = await authenticatedFetch("/api/badges", {
            method: "POST",
            body: JSON.stringify({
              productId,
              optionValue,
              badgeType,
            }),
          });

          if (response.ok) {
            console.log("‚úÖ Badge saved");
            loadProductBadges();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("Failed to save badge:", error);
          alert("Failed to save badge");
        }
      }

      // Load products on start
      loadProducts();

      // ============================================
      // SETTINGS
      // ============================================

      async function loadSettings() {
        try {
          const response = await authenticatedFetch(`/api/settings`);

          if (!response.ok) {
            console.error("Failed to load settings, status:", response.status);
            return;
          }

          const settings = await response.json();

          document.getElementById("enable-display").checked =
            settings.enabled !== false;
          document.getElementById("option-type").value =
            settings.selectedOption || "";

          window.settingsLoaded = true;
          console.log("‚úÖ Settings loaded");
        } catch (error) {
          console.error("Failed to load settings:", error);
        }
      }

      async function saveSettings() {
        const enabled = document.getElementById("enable-display").checked;
        const selectedOption = document.getElementById("option-type").value;

        if (!selectedOption) {
          alert("Please select an option type");
          return;
        }

        try {
          const response = await authenticatedFetch("/api/settings", {
            method: "POST",
            body: JSON.stringify({
              enabled,
              selectedOption,
            }),
          });

          if (response.ok) {
            alert("‚úÖ Settings saved!");
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("Failed to save settings:", error);
          alert("Failed to save settings");
        }
      }

      // ============================================
      // PLANS
      // ============================================

      function upgradePlan(plan) {
        if (plan === "enterprise") {
          switchTab("help");
        } else {
          alert(
            `Upgrade to ${plan} plan - Shopify billing integration coming soon!`
          );
        }
      }

      // ============================================
      // HELP
      // ============================================

      function toggleFaq(element) {
        const answer = element.nextElementSibling;
        const icon = element.querySelector(".faq-icon");

        answer.classList.toggle("open");
        icon.classList.toggle("open");
      }

      function openLiveChat() {
        alert(
          "Live chat integration coming soon! For now, please email support@variantbadges.com"
        );
      }
    </script>
  </body>
</html>
