<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variant Badges App</title>
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f4f6f8;
        color: #202223;
        padding: 20px;
      }
      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .header h1 {
        font-size: 24px;
        font-weight: 600;
      }
      .status-badge {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
      }
      .status-badge.connected {
        background: #d1f0e5;
        color: #008060;
      }
      .status-badge.loading {
        background: #fff4cc;
        color: #916a00;
      }
      .status-badge.error {
        background: #ffc2c2;
        color: #bf0711;
      }

      .option-selector {
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .option-selector h2 {
        font-size: 18px;
        margin-bottom: 15px;
      }
      .option-selector select {
        width: 100%;
        padding: 12px;
        border: 1px solid #c9cccf;
        border-radius: 4px;
        font-size: 14px;
      }
      .option-selector p {
        margin-top: 10px;
        color: #6d7175;
        font-size: 14px;
      }

      .products-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .product-card {
        border: 1px solid #e1e3e5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .product-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #202223;
      }
      .variant-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #e1e3e5;
      }
      .variant-row:last-child {
        border-bottom: none;
      }
      .variant-info {
        flex: 1;
      }
      .variant-info strong {
        display: block;
        margin-bottom: 4px;
      }
      .variant-info .option-value {
        color: #6d7175;
        font-size: 14px;
      }
      .badge-controls {
        display: flex;
        gap: 8px;
      }
      .badge-btn {
        padding: 8px 16px;
        border: 2px solid #e1e3e5;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background: white;
        transition: all 0.2s;
      }
      .badge-btn:hover {
        border-color: #008060;
      }
      .badge-btn.hot {
        border-color: #ff4d4d;
        background: #fff5f5;
        color: #ff4d4d;
      }
      .badge-btn.new {
        border-color: #1f8eff;
        background: #f0f7ff;
        color: #1f8eff;
      }
      .badge-btn.sale {
        border-color: #ff9500;
        background: #fff8e6;
        color: #ff9500;
      }
      .badge-btn.active {
        font-weight: 700;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6d7175;
      }
      .empty-state h2 {
        font-size: 20px;
        margin-bottom: 10px;
        color: #202223;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Variant Badges</h1>
      <span class="status-badge loading" id="status">Loading...</span>
    </div>

    <div class="option-selector" id="optionSelector" style="display: none">
      <h2>Select Product Option</h2>
      <select id="optionSelect">
        <option value="">Choose an option...</option>
      </select>
      <p>
        Select which product option (e.g., Size, Color) you want to assign
        badges to.
      </p>
    </div>

    <div class="products-container">
      <div id="products">
        <div class="empty-state">
          <h2>Loading your products...</h2>
          <p>Please wait while we connect to your store</p>
        </div>
      </div>
    </div>

    <script>
      const appHost = "{{APP_HOST}}";
      const apiKey = "{{SHOPIFY_API_KEY}}";
      const urlParams = new URLSearchParams(window.location.search);
      const shop = urlParams.get("shop");
      const host = urlParams.get("host");

      let app = null;
      let currentToken = null;
      let allProducts = [];
      let selectedOption = null;
      let badgeAssignments = [];

      // Initialize App Bridge
      async function initAppBridge() {
        return new Promise((resolve) => {
          let attempts = 0;
          const checkInterval = setInterval(() => {
            if (window.shopify && window.shopify.environment) {
              clearInterval(checkInterval);
              app = window.shopify;
              console.log("App Bridge initialized");
              resolve(true);
            } else if (attempts++ > 30) {
              clearInterval(checkInterval);
              console.log("App Bridge timeout, using URL token");
              resolve(false);
            }
          }, 100);
        });
      }

      // Get session token
      async function getSessionToken() {
        const urlToken = urlParams.get("id_token");
        if (urlToken) {
          console.log("Using token from URL (fast path)");
          return urlToken;
        }

        if (app && app.idToken) {
          try {
            currentToken = await Promise.race([
              app.idToken(),
              new Promise((_, reject) =>
                setTimeout(() => reject(new Error("App Bridge timeout")), 2000)
              ),
            ]);
            return currentToken;
          } catch (err) {
            console.log("App Bridge failed:", err.message);
          }
        }

        throw new Error("No session token available");
      }

      // Fetch products
      async function loadProducts() {
        try {
          document.getElementById("status").textContent = "Initializing...";
          await initAppBridge();

          document.getElementById("status").textContent = "Loading Products...";
          const token = await getSessionToken();

          const response = await fetch(
            appHost + "/api/products?shop=" + encodeURIComponent(shop),
            {
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            if (errorData.needsAuth) {
              showReinstallButton();
              return;
            }
            throw new Error("Failed to fetch products");
          }

          const data = await response.json();
          allProducts = data.products;

          // Load badge assignments
          await loadBadgeAssignments(token);

          // Extract and show options
          showOptionSelector();

          document.getElementById("status").textContent = "Connected";
          document.getElementById("status").className =
            "status-badge connected";
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("status").textContent = "Error";
          document.getElementById("status").className = "status-badge error";
        }
      }

      // Load existing badge assignments
      async function loadBadgeAssignments(token) {
        try {
          const response = await fetch(
            appHost + "/api/badges?shop=" + encodeURIComponent(shop),
            {
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            badgeAssignments = data.badges;
            console.log("Loaded badge assignments:", badgeAssignments.length);
          }
        } catch (error) {
          console.error("Error loading badges:", error);
        }
      }

      // Extract unique options from products
      function extractOptions() {
        const optionsSet = new Set();
        allProducts.forEach((product) => {
          product.options.forEach((option) => {
            optionsSet.add(option.name);
          });
        });
        return Array.from(optionsSet);
      }

      // Show option selector
      function showOptionSelector() {
        const options = extractOptions();
        const select = document.getElementById("optionSelect");

        options.forEach((option) => {
          const optionElement = document.createElement("option");
          optionElement.value = option;
          optionElement.textContent = option;
          select.appendChild(optionElement);
        });

        document.getElementById("optionSelector").style.display = "block";

        select.addEventListener("change", (e) => {
          selectedOption = e.target.value;
          if (selectedOption) {
            displayFilteredProducts();
          } else {
            document.getElementById("products").innerHTML = `
              <div class="empty-state">
                <h2>Select an option above</h2>
                <p>Choose which product option you want to work with</p>
              </div>
            `;
          }
        });
      }

      // Display products filtered by selected option
      function displayFilteredProducts() {
        const productsDiv = document.getElementById("products");

        // Filter products that have the selected option
        const filteredProducts = allProducts.filter((product) =>
          product.options.some((opt) => opt.name === selectedOption)
        );

        if (filteredProducts.length === 0) {
          productsDiv.innerHTML = `
            <div class="empty-state">
              <h2>No products found</h2>
              <p>No products have the "${selectedOption}" option</p>
            </div>
          `;
          return;
        }

        let html = "";
        filteredProducts.forEach((product) => {
          // Get the option index
          const optionIndex = product.options.findIndex(
            (opt) => opt.name === selectedOption
          );

          html += `
            <div class="product-card">
              <div class="product-title">${product.title}</div>
          `;

          product.variants.forEach((variant) => {
            const optionValue =
              variant.title.split(" / ")[optionIndex] || variant.title;
            const variantBadges = badgeAssignments.filter(
              (b) => b.variant_id === variant.id
            );

            html += `
              <div class="variant-row">
                <div class="variant-info">
                  <strong>${variant.title}</strong>
                  <span class="option-value">${selectedOption}: ${optionValue}</span>
                </div>
                <div class="badge-controls">
                  <button class="badge-btn ${
                    variantBadges.find((b) => b.badge_type === "HOT")
                      ? "hot active"
                      : ""
                  }" 
                          onclick="toggleBadge('${product.id}', '${
              variant.id
            }', 'HOT', '${optionValue}')">
                    ${
                      variantBadges.find((b) => b.badge_type === "HOT")
                        ? "✓ "
                        : ""
                    }HOT
                  </button>
                  <button class="badge-btn ${
                    variantBadges.find((b) => b.badge_type === "NEW")
                      ? "new active"
                      : ""
                  }" 
                          onclick="toggleBadge('${product.id}', '${
              variant.id
            }', 'NEW', '${optionValue}')">
                    ${
                      variantBadges.find((b) => b.badge_type === "NEW")
                        ? "✓ "
                        : ""
                    }NEW
                  </button>
                  <button class="badge-btn ${
                    variantBadges.find((b) => b.badge_type === "SALE")
                      ? "sale active"
                      : ""
                  }" 
                          onclick="toggleBadge('${product.id}', '${
              variant.id
            }', 'SALE', '${optionValue}')">
                    ${
                      variantBadges.find((b) => b.badge_type === "SALE")
                        ? "✓ "
                        : ""
                    }SALE
                  </button>
                </div>
              </div>
            `;
          });

          html += `</div>`;
        });

        productsDiv.innerHTML = html;
      }

      // Toggle badge assignment
      async function toggleBadge(productId, variantId, badgeType, optionValue) {
        try {
          const existingBadge = badgeAssignments.find(
            (b) => b.variant_id === variantId && b.badge_type === badgeType
          );

          const token = await getSessionToken();

          if (existingBadge) {
            // Remove badge
            const response = await fetch(
              `${appHost}/api/badges/${variantId}/${badgeType}?shop=${encodeURIComponent(
                shop
              )}`,
              {
                method: "DELETE",
                headers: {
                  Authorization: "Bearer " + token,
                  "Content-Type": "application/json",
                },
              }
            );

            if (response.ok) {
              badgeAssignments = badgeAssignments.filter(
                (b) =>
                  !(b.variant_id === variantId && b.badge_type === badgeType)
              );
              console.log("Badge removed:", badgeType);
            }
          } else {
            // Add badge
            const response = await fetch(
              appHost + "/api/badges?shop=" + encodeURIComponent(shop),
              {
                method: "POST",
                headers: {
                  Authorization: "Bearer " + token,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  productId,
                  variantId,
                  badgeType,
                  optionValue,
                }),
              }
            );

            if (response.ok) {
              badgeAssignments.push({
                product_id: productId,
                variant_id: variantId,
                badge_type: badgeType,
                option_value: optionValue,
              });
              console.log("Badge added:", badgeType);
            }
          }

          // Refresh display
          displayFilteredProducts();
        } catch (error) {
          console.error("Error toggling badge:", error);
          alert("Failed to update badge. Please try again.");
        }
      }

      // Show reinstall button
      function showReinstallButton() {
        document.getElementById("status").textContent = "Reinstall Required";
        document.getElementById("status").className = "status-badge error";

        const authUrl = appHost + "/auth?shop=" + encodeURIComponent(shop);
        document.getElementById("products").innerHTML =
          '<div class="empty-state">' +
          "<h2>Reinstall Required</h2>" +
          '<p style="margin: 20px 0;">Your access token has expired.</p>' +
          '<a href="' +
          authUrl +
          '" target="_top" ' +
          'style="display: inline-block; padding: 16px 40px; background: #008060; color: white; ' +
          'text-decoration: none; border-radius: 4px; font-weight: 600;">Reinstall App</a>' +
          "</div>";
      }

      // Auto-refresh token
      function startTokenRefresh() {
        setInterval(async () => {
          if (app && app.idToken) {
            try {
              currentToken = await app.idToken();
              console.log("Token auto-refreshed");
            } catch (err) {
              console.log("Token refresh failed:", err.message);
            }
          }
        }, 50000);
      }

      // Start the app
      loadProducts();
      startTokenRefresh();
    </script>
  </body>
</html>
